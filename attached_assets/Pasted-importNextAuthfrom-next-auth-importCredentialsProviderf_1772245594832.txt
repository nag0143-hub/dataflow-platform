importNextAuthfrom"next-auth";importCredentialsProviderfrom"next-auth/providers/credentials";import {LDAP_ADMIN_DN,LDAP_ENTITLEMENT_CHECK,LDAP_URL,LDAP_USER_SEARCH_BASE,} from"../../../utils/Constants";const { authenticate } = require("ldap-authentication");const { exec } = require("child_process");
exportconst authOptions = {providers: [CredentialsProvider({name: "LDAP",credentials: {username: {label: "Preferred ID",type: "text",placeholder: "",},password: { label: "Password", type:"password" },},async authorize(credentials, req) {console.log("Authorizing user:", credentials.username);const password = process.env.BDPOPS_APPID_PASSWORD;if (!password) {console.error("LDAP admin password not found in environment");thrownewError("Could not fetch LDAP admin password");}let options = {ldapOpts: {url: LDAP_URL,tlsOptions: { rejectUnauthorized: false },},adminDn: LDAP_ADMIN_DN,adminPassword: password,userPassword: credentials.password,userSearchBase: LDAP_USER_SEARCH_BASE,usernameAttribute: "sAMAccountName",username: credentials.username,starttls: false,};
returnnewPromise(async (resolve, reject) => {try {const user =await authenticate(options);if (user) {console.log("User authenticated:", user.cn);resolve({uid: user.uid,username: user.cn,password: credentials.password,memberOf: user.memberOf,firstName: user.givenName || user.cn?.split(" ")[0] || "User",});}} catch (e) {console.error("Authentication error:", e.message || e);reject("Could not authenticate");}});},}),],theme: {colorScheme: "light",// "auto" | "dark" | "light"brandColor: "",// Hex color codelogo: "",// Absolute URL to image},// pages: {// signIn: "/auth/signin",// signOut: "/auth/signout",// error: "/auth/error", // Error code passed in query string as ?error=// },callbacks: {session: {jwt: true,maxAge: 7 *24 *60 *60,// days},async session({ session, token }) {return {...session,username: { name: token.username, uid: token.uid },firstName: token.firstName,};},async jwt({ token, user }) {const isSignIn = user ?true :false;
if (isSignIn && isMemberOf(user)) {console.log("JWT token created for user:", user.username);token.username = user.username;token.password = user.password;token.uid = user.uid;token.firstName = user.firstName;}return token;},},};
exportdefaultNextAuth(authOptions);
const isMemberOf = (ldapObj) => {const memberOf = ldapObj.memberOf;return memberOf.includes(LDAP_ENTITLEMENT_CHECK);};